{"type":"javascript","name":"网页弹窗拦截","version":"1.2.7","tags":["工具脚本","其他脚本"],"synopsis":"弹窗次数过多时询问是否拦截某弹窗","source":" /*\n * @name: 网页弹窗拦截\n * @Author: undefined303（残月un）\n * @version: 1.2.7\n * @include: *\n */\nimport { runAt, runOnce } from '@bext/util';\nimport { toast } from \"@bext/ui\";\n\nimport config from '@bext/config';\nrunOnce(()=> {\n'use strict';\n\n/*当某弹窗弹出次数达到此值的倍数时，询问是否拦截*/\n/*当询问是否拦截次数达到该值的次数时，询问是否放行，填null则不会询问*/\n/*是否用toast显示被拦截的弹窗内容？true为是，false为否*/\n/*白名单网站：将网站完整地址或域名用\"\"包裹，并用英文逗号隔开\n示例：\n     单个网站\nconst IGNORED_SITE =[\"example.com\"]\n     多个网站\nconst IGNORED_SITE =[\"example1.com\",\"https://example2.com/example\"]\n*/\n\nconst {\n  CONFIRM_COUNT = 5,\n  ASK_IGNORE_COUNT = null,\n  TOAST = true,\n  IGNORED_SITE = []\n} = config;\n/*****************以下勿改*****************/\n\nlet msgList=[];\nlet toast_var=TOAST\nif(toast_var){\nvar time=0\nrunAt('document-end', ()=>{\nvar msgListener=setInterval(()=>{\nif((Math.round(new Date())-time)>1300&&msgList.length>0){\ntoast(\n    (msgList.shift()), \n    0.7, \n    { \n      text: '本次不再显示', \n      color: 'turquoise', \n      onclick:()=>{\ntoast_var=false;\nclearInterval(msgListener);\nmsgList=[];\n},\n    },\n  );\ntime=Math.round(new Date());\n}\n},1)\n});\n}\nIGNORED_SITE.forEach((item,index) =>{\ntry{\nIGNORED_SITE[index]=new URL(item).href\n}catch(e){/*ignore error*/}\n});\nif(!(IGNORED_SITE.indexOf(document.domain)!=-1||IGNORED_SITE.indexOf(location.href)!=-1)){\nconsole.log(\"启用网页弹窗拦截\")\nconst originalConfirm =window.confirm;\n[\"alert\", \"confirm\", \"prompt\"].forEach((method) => {\nlet count = 0;\nlet count_time = 1;\nlet ignore = false;\nlet ask=true;\nconst fn = window[method] ;\nwindow[method]=function(){\nif(ignore) {\nmsgList.push(`拦截${method}: ${(arguments.length==0)?\"\":String(arguments[0])}`)\nreturn undefined;\n}\nconst result = fn((arguments.length==0)?\"\":String(arguments[0]));\ncount++;\nif (count == CONFIRM_COUNT*count_time) {\nif(ask){\nignore = originalConfirm(\n`当前网页已弹出${method}弹窗${count}次，是否忽略后续该弹窗？`);\n}\nif(ASK_IGNORE_COUNT!=null&&!ignore){\nif(count_time==ASK_IGNORE_COUNT&&originalConfirm(`是否本次放行本网站的${method}弹窗？\\n如需永久放行，请将该网站域名或完整链接添加至白名单。`)){\nask=false;\n}\n}\ncount_time++;\n}\nreturn result;\n};\n});\n}\n  function iframeTest(iframe){\nif(iframe.srcdoc.length!=0&&!(/undefined303AlertInterceptionEvent/.test(iframe.srcdoc))){\niframe.srcdoc=[iframe.srcdoc,`<script>\nwindow.alert=function(){\nif(arguments.length==0){msg=\"\"}else{msg=String(arguments[0])}\nwindow.parent.document.dispatchEvent(new CustomEvent('undefined303AlertInterceptionEvent', {detail:msg}))\n}\n;(function () {\n${iframeTest}\ndocument.querySelectorAll(\"iframe\").forEach( el => iframeTest(el));\nconst mu = new MutationObserver(mrs => {\n  for (let mr of mrs) {\n    if (mr.addedNodes.length>0) {\n      mr.addedNodes.forEach( ad => {\n        if (ad.nodeName==='IFRAME' &&\n          ad.getAttribute(\"srcdoc\")\n        ) iframeTest(ad);\n      });\n    } else if (mr.type==='attributes') {\n      if (mr.target.nodeName==='IFRAME' &&\n        mr.target.getAttribute(\"srcdoc\")\n      ) iframeTest(mr.target);\n    }\n  }\n});\nmu.observe(document.all[0],{\n  childList: true,\n  subtree: true,\n  attributes: true,\n  attributeFilter: [\"srcdoc\"]\n});\nwindow.document.addEventListener('undefined303AlertInterceptionEvent', handleEvent, false)\nfunction handleEvent(e) {\n  alert(e.detail)\n}\n})();<\\/script>`].join(\"\")\n}\n}\ndocument.querySelectorAll(\"iframe\").forEach( el => iframeTest(el));\nconst mu = new MutationObserver(mrs => {\n  for (let mr of mrs) {\n    if (mr.addedNodes.length>0) {\n      mr.addedNodes.forEach( ad => {\n        if (ad.nodeName==='IFRAME' &&\n          ad.getAttribute(\"srcdoc\")\n        ) iframeTest(ad);\n      });\n    } else if (mr.type==='attributes') {\n      if (mr.target.nodeName==='IFRAME' &&\n        mr.target.getAttribute(\"srcdoc\")\n      ) iframeTest(mr.target);\n    }\n  }\n});\nmu.observe(document.all[0],{\n  childList: true,\n  subtree: true,\n  attributes: true,\n  attributeFilter: [\"srcdoc\"]\n});\nwindow.document.addEventListener('undefined303AlertInterceptionEvent', handleEvent, false)\nfunction handleEvent(e) {\n  alert(e.detail)\n}\n})","detail":"<p><br></p><p>网页弹窗有三种：alert，confirm，prompt，分别为：警告框，确认框和输入框，有的网站会滥用这三种弹窗，给用户造成极大的干扰。</p><p><br></p><p>脚本预设参数 <strong>CONFIRM_COUNT=5</strong> （可修改），当某类弹窗弹出次数达该参数的倍数时，询问是否拦截该类弹窗，拦截刷新解除。</p><p><br></p><p>测试页面 <a rel=\"noopener noreferrer\" href=\"http://www.rs100.cn/fun/fun.htm\">http://www.rs100.cn/fun/fun.htm</a></p>","extra":{"xMetaComment":"// @run-at document-start"},"configSchema":{"type":"object","properties":{"CONFIRM_COUNT":{"type":"number","description":"当某弹窗弹出次数达到此值的倍数时，询问是否拦截","minimum":1},"ASK_IGNORE_COUNT":{"type":"number","description":"当询问是否拦截次数达到该值的次数时，询问是否放行，不填则不会询问","minimum":1},"TOAST":{"type":"boolean","title":"用toast显示被拦截的弹窗内容"},"IGNORED_SITE":{"type":"array","items":{"type":"string"},"description":"例如 example.com 或者 https://example.com，点击加号添加多个","title":"白名单网站"}}},"defaultConfig":{"CONFIRM_COUNT":5,"ASK_IGNORE_COUNT":3,"TOAST":true}}